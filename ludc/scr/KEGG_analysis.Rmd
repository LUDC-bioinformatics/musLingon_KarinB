---
title: "LingonProj KEGG Analysis"
author:
   name: "Shuyi Li"
   email: shuyi.li@med.lu.se
   affiliation: LUDC Bioinformatics Unit
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, eval=TRUE, message=FALSE)
knitr::opts_knit$set(root.dir = '../')
```

Load data
```{r}
DEseq_res <- read.table("results/tables/deseq/LingonProj_DESeqres.csv", header = TRUE)

```

```{r,message=FALSE}
#load packages
library(clusterProfiler)
library(org.Mm.eg.db)
library(ggplot2)
```

## Gene Set Enrichment Analysis
(clusterProfiler v3.16.1  For help: https://guangchuangyu.github.io/software/clusterProfiler)

### HFD vs LFD

```{r}
ids <- bitr(DEseq_res$gene, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb=org.Mm.eg.db)
dedup_ids <- ids[!duplicated(ids[c("ENSEMBL")]),]
DEseq_res2 <- DEseq_res[DEseq_res$gene %in% dedup_ids$ENSEMBL,]
DEseq_res2$ENTREZID <- dedup_ids$ENTREZID
kegg_HFD_vs_LFD_gene_list <- DEseq_res2$log2FoldChange_HFD_vs_LFD
names(kegg_HFD_vs_LFD_gene_list) <- DEseq_res2$ENTREZID
kegg_HFD_vs_LFD_gene_list <- na.omit(kegg_HFD_vs_LFD_gene_list)
kegg_HFD_vs_LFD_gene_list = sort(kegg_HFD_vs_LFD_gene_list, decreasing = TRUE)

kegg_HFD_vs_LFD <- gseKEGG(geneList = kegg_HFD_vs_LFD_gene_list,
               organism     = "mmu",
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
# write result
kegg_HFD_vs_LFD <- setReadable(kegg_HFD_vs_LFD, OrgDb = org.Mm.eg.db, keyType="ENTREZID")
file_name <- "results/tables/KEGG_results/KEGG_GSEA_HFD_LFD.csv"
write.csv(as.data.frame(kegg_HFD_vs_LFD),file_name,row.names = F)
```

* Dotplot: 
It depicts the enrichment scores (e.g. p values) and gene count or ratio.

* Enrichment map: 
Enrichment map organizes enriched terms into a network with edges connecting overlapping gene sets. In this way, mutually overlapping gene sets are tend to cluster together, making it easy to identify functional module.

* Ridgeplot: 
The ridgeplot will visualize expression distributions of core enriched genes for GSEA enriched categories. It helps users to interpret up/down-regulated pathways.

Dotplot

```{r,fig.width=10, fig.height=4}
dotplot(kegg_HFD_vs_LFD, font.size = 12, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)
```

Enrichment map

```{r,fig.width=10, fig.height=4}
emapplot(kegg_HFD_vs_LFD)
```

Ridgeplot

```{r, fig.width=10, fig.height=10}
ridgeplot(kegg_HFD_vs_LFD) + labs(x = "enrichment distribution")
```

### HFD vs Lingon

```{r}
kegg_HFD_vs_Lingon_gene_list <- DEseq_res2$log2FoldChange_HFD_vs_Lingon
names(kegg_HFD_vs_Lingon_gene_list) <- DEseq_res2$ENTREZID
kegg_HFD_vs_Lingon_gene_list <- na.omit(kegg_HFD_vs_Lingon_gene_list)
kegg_HFD_vs_Lingon_gene_list = sort(kegg_HFD_vs_Lingon_gene_list, decreasing = TRUE)

kegg_HFD_vs_Lingon <- gseKEGG(geneList = kegg_HFD_vs_Lingon_gene_list,
               organism     = "mmu",
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
kegg_HFD_vs_Lingon <- setReadable(kegg_HFD_vs_Lingon, OrgDb = org.Mm.eg.db, keyType="ENTREZID")
file_name <- "results/tables/KEGG_results/KEGG_GSEA_HFD_Lingon.csv"
write.csv(as.data.frame(kegg_HFD_vs_Lingon),file_name,row.names = F)
```

Dotplot

```{r,fig.width=10, fig.height=4}
dotplot(kegg_HFD_vs_Lingon, font.size = 14, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)
```

Enrichment map

```{r,fig.width=10, fig.height=3}
emapplot(kegg_HFD_vs_Lingon)
```

Ridgeplot

```{r,fig.width=10, fig.height=10}
ridgeplot(kegg_HFD_vs_Lingon) + labs(x = "enrichment distribution")
```

### LFD vs Lingon

```{r}
kegg_LFD_vs_Lingon_gene_list <- DEseq_res2$log2FoldChange_LFD_vs_Lingon
names(kegg_LFD_vs_Lingon_gene_list) <- DEseq_res2$ENTREZID
kegg_LFD_vs_Lingon_gene_list <- na.omit(kegg_LFD_vs_Lingon_gene_list)
kegg_LFD_vs_Lingon_gene_list = sort(kegg_LFD_vs_Lingon_gene_list, decreasing = TRUE)

kegg_LFD_vs_Lingon <- gseKEGG(geneList = kegg_LFD_vs_Lingon_gene_list,
               organism     = "mmu",
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
kegg_LFD_vs_Lingon <- setReadable(kegg_LFD_vs_Lingon, OrgDb = org.Mm.eg.db, keyType="ENTREZID")
file_name <- "results/tables/KEGG_results/KEGG_GSEA_LFD_Lingon.csv"
write.csv(as.data.frame(kegg_LFD_vs_Lingon),file_name,row.names = F)
```

Dotplot

```{r,fig.width=10, fig.height=4}
dotplot(kegg_LFD_vs_Lingon, font.size = 12, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)
```

Enrichment map

```{r,fig.width=10, fig.height=3}
emapplot(kegg_LFD_vs_Lingon)
```

Ridgeplot

```{r,fig.width=10, fig.height=10}
ridgeplot(kegg_LFD_vs_Lingon) + labs(x = "enrichment distribution")
```

## Over-representation test

### HFD vs LFD

```{r}
sign_genes <- gsub('\\..*', '',DEseq_res2$ENTREZID[which(DEseq_res2$padj_HFD_vs_LFD <= 0.1)])
enrich_HFD_LFD <- enrichKEGG(gene         = sign_genes,
                 keyType = 'ncbi-geneid',
                 organism     = 'mmu',
                 universe = DEseq_res2$ENTREZID,
                 pvalueCutoff = 0.1)
enrich_HFD_LFD <- setReadable(enrich_HFD_LFD, OrgDb = org.Mm.eg.db, keyType="ENTREZID")
file_name <- "results/tables/KEGG_results/KEGG_enrich_HFD_LFD.csv"
write.csv(as.data.frame(enrich_HFD_LFD),file_name,row.names = F)
```

Dotplot

```{r,fig.width=10, fig.height=4}
dotplot(enrich_HFD_LFD, font.size = 12, showCategory = 15)
```

Enrichment map

```{r,fig.width=10, fig.height=3}
emapplot(enrich_HFD_LFD)
```

### HFD vs Lingon

```{r}
sign_genes <- gsub('\\..*', '',DEseq_res2$ENTREZID[which(DEseq_res2$padj_HFD_vs_Lingon <= 0.1)])
enrich_HFD_Lingon <- enrichKEGG(gene         = sign_genes,
                 keyType = 'ncbi-geneid',
                 organism     = 'mmu',
                 universe = DEseq_res2$ENTREZID,
                 pvalueCutoff = 0.1)
file_name <- "results/tables/KEGG_results/KEGG_enrich_HFD_Lingon.csv"
write.csv(as.data.frame(enrich_HFD_Lingon),file_name,row.names = F)
```

* No enrichment terms found...

### LFD vs Lingon

```{r}
sign_genes <- gsub('\\..*', '',DEseq_res2$ENTREZID[which(DEseq_res2$padj_LFD_vs_Lingon <= 0.1)])
enrich_LFD_Lingon <- enrichKEGG(gene         = sign_genes,
                 keyType = 'ncbi-geneid',
                 organism     = 'mmu',
                 universe = DEseq_res2$ENTREZID,
                 pvalueCutoff = 0.1)
enrich_LFD_Lingon <- setReadable(enrich_LFD_Lingon, OrgDb = org.Mm.eg.db, keyType="ENTREZID")
file_name <- "results/tables/KEGG_results/KEGG_enrich_LFD_Lingon.csv"
write.csv(as.data.frame(enrich_LFD_Lingon),file_name,row.names = F)
```

Dotplot

```{r,fig.width=10, fig.height=4}
dotplot(enrich_LFD_Lingon, font.size = 12, showCategory = 15)
```

Enrichment map

```{r,fig.width=10, fig.height=3}
emapplot(enrich_LFD_Lingon)
```

### KEGG analysis results

[KEGG analysis results click here](../results/tables/KEGG_results)
